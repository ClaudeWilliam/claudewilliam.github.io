<!DOCTYPE html><html lang="zh-Hans" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>ElasticSearch查询浅谈 | Hill's Notes</title><meta name="keywords" content="ElasticSearch"><meta name="author" content="Hill"><meta name="copyright" content="Hill"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="什么是ElasticSearchElasticsearch是一个基于Lucene库的搜索引擎。它提供了一个分布式、支持多租户的全文搜索引擎，具有HTTP Web接口和无模式JSON文档。 简单来说ES是一个搜索引擎，通过URI Search API和 DSL Search API 两种搜索方式，它的底层数据结构是倒排索引，实现快速搜索。 ElasticSearch 一般存储的是非机构化的数据，简单">
<meta property="og:type" content="article">
<meta property="og:title" content="ElasticSearch查询浅谈">
<meta property="og:url" content="https://blog.51cloud.win/2023/01/20/ElasticSearch%E6%9F%A5%E8%AF%A2%E6%B5%85%E8%B0%88/index.html">
<meta property="og:site_name" content="Hill&#39;s Notes">
<meta property="og:description" content="什么是ElasticSearchElasticsearch是一个基于Lucene库的搜索引擎。它提供了一个分布式、支持多租户的全文搜索引擎，具有HTTP Web接口和无模式JSON文档。 简单来说ES是一个搜索引擎，通过URI Search API和 DSL Search API 两种搜索方式，它的底层数据结构是倒排索引，实现快速搜索。 ElasticSearch 一般存储的是非机构化的数据，简单">
<meta property="og:locale">
<meta property="og:image" content="https://blog.51cloud.win/img/00037.jpg">
<meta property="article:published_time" content="2023-01-20T12:03:14.000Z">
<meta property="article:modified_time" content="2023-02-12T07:26:53.157Z">
<meta property="article:author" content="Hill">
<meta property="article:tag" content="ElasticSearch">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://blog.51cloud.win/img/00037.jpg"><link rel="shortcut icon" href="/img/flag.jpg"><link rel="canonical" href="https://blog.51cloud.win/2023/01/20/ElasticSearch%E6%9F%A5%E8%AF%A2%E6%B5%85%E8%B0%88/"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: 'Copy successfully',
    error: 'Copy error',
    noSupport: 'The browser does not support'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  date_suffix: {
    just: 'Just',
    min: 'minutes ago',
    hour: 'hours ago',
    day: 'days ago',
    month: 'months ago'
  },
  copyright: {"limitCount":50,"languages":{"author":"Author: Hill","link":"Link: ","source":"Source: Hill's Notes","info":"Copyright is owned by the author. For commercial reprints, please contact the author for authorization. For non-commercial reprints, please indicate the source."}},
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    jQuery: 'https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js',
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/js/jquery.justifiedGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/css/justifiedGallery.min.css'
    },
    fancybox: {
      js: 'https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js',
      css: 'https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isanchor: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = { 
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2023-02-12 15:26:53'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    })(window)</script><meta name="generator" content="Hexo 5.4.0"></head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="author-avatar"><img class="avatar-img" src="/img/dog.jpg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data"><div class="data-item is-center"><div class="data-item-link"><a href="/archives/"><div class="headline">Articles</div><div class="length-num">46</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/tags/"><div class="headline">Tags</div><div class="length-num">26</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/categories/"><div class="headline">Categories</div><div class="length-num">15</div></a></div></div></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('/img/00037.jpg')"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">Hill's Notes</a></span><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">ElasticSearch查询浅谈</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">Created</span><time class="post-meta-date-created" datetime="2023-01-20T12:03:14.000Z" title="Created 2023-01-20 20:03:14">2023-01-20</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">Updated</span><time class="post-meta-date-updated" datetime="2023-02-12T07:26:53.157Z" title="Updated 2023-02-12 15:26:53">2023-02-12</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E7%BC%96%E7%A8%8B/">编程</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="ElasticSearch查询浅谈"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">Post View:</span><span id="busuanzi_value_page_pv"></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h3 id="什么是ElasticSearch"><a href="#什么是ElasticSearch" class="headerlink" title="什么是ElasticSearch"></a>什么是ElasticSearch</h3><p>Elasticsearch是一个基于Lucene库的搜索引擎。它提供了一个分布式、支持多租户的全文搜索引擎，具有HTTP Web接口和无模式JSON文档。</p>
<p>简单来说ES是一个搜索引擎，通过URI Search API和 DSL Search API 两种搜索方式，它的底层数据结构是倒排索引，实现快速搜索。</p>
<p>ElasticSearch 一般存储的是非机构化的数据，简单来说就是JSON。它可以根据JSON内容自动生成索引（index），针对自动生成索引也可以使用index template 自动生成对应的mapping，也可以自己创建索引在导入数据。（我们一般在生产上都是先指定索引在导入数据）。</p>
<h4 id="ES中的一些名词解释"><a href="#ES中的一些名词解释" class="headerlink" title="ES中的一些名词解释"></a>ES中的一些名词解释</h4><p><strong>索引（index）</strong>：ES中索引是文档的容器，是一类文档的结合，Index体现了逻辑空间的概念，每个索引都有自己的mapping的定义。用于定义包含文档的字段名和字段类型。</p>
<p>查看索引的对应的DSL 语句</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#查看所有index的详细信息</span></span><br><span class="line">GET /_cat/indices</span><br><span class="line"></span><br><span class="line">green  open kibana_sample_data_ecommerce 56ybxw24QKSG_pBjqsd7Gg 1 0  4675 0   4.9mb   4.9mb</span><br><span class="line">green  open kibana_sample_data_flights   J_7ex02RTYqyzDak6plTXg 1 0 13059 0   6.4mb   6.4mb</span><br><span class="line"></span><br><span class="line">GET _cat/indices?v</span><br><span class="line">health status index                        uuid                   pri rep docs.count</span><br><span class="line">green  open   kibana_sample_data_flights   J_7ex02RTYqyzDak6plTXg   1   0      13059 </span><br><span class="line">green  open   kibana_sample_data_ecommerce 56ybxw24QKSG_pBjqsd7Gg   1   0       467</span><br></pre></td></tr></table></figure>

<p><strong>类型（type）</strong>：ES中的type只是基本字段，当您执行 GET /my_index/my_type/_search 时，t将为字段 _type 的 my_type 值运行预过滤器 ， type就像一个自动过滤器。不要将索引和类型视为 SQL 世界中的数据库和表。type在ES的版本升级中逐渐放弃使用。</p>
<p><strong>Elasticsearch 5.6.0</strong></p>
<p>通过对 index 设置参数 <code>index.mapping.single_type: true</code> 就能够启用单 index 单 type 限制（一个 index 只能支持一个 type），同样该限制从 6.0 版本开始该限制会强制启用。</p>
<p><strong>Elasticsearch 6.x</strong></p>
<p>在 Elasticsearch 6.x 中，一个 index 只能支持一个 type，推荐的 type 名字为 _doc（这样可以在 API 方面向后兼容 7.x ）</p>
<p>在 Elasticsearch 6.8 中，Elasticsearch 引入了一个参数控制 type 开关：<code>include_type_name</code>，默认值为 true，表示仍使用 type，手动设置为 false 后，请求 es 的 API 将不再包含 type，而是使用类 <code>PUT /&#123;index&#125;/_doc/&#123;id&#125;</code> 的格式</p>
<p><strong>Elasticsearch 7.x</strong></p>
<p>在 Elasticsearch 7.x 中，<code>include_type_name</code> 被默认置为 false，新的 index API 格式为 <code>PUT /&#123;index&#125;/_doc/&#123;id&#125;</code> 和 <code>POST &#123;index&#125;/_doc</code> 。<strong>需要注意的是，_doc 并不是一个 type ，而仅仅是 API 请求路径中永久的一部分。手动创建索引不用指定type</strong></p>
<p><strong>Elasticsearch 8.x</strong></p>
<p>在 Elasticsearch 8.x 中，<code>include_type_name</code> 已被删除，同时也表示 es 不再支持任何自定义 type 。</p>
<p><strong>字段（field）：</strong>ES中的字段类似MySQL数据库中的表字段（Colum），不过ES一个Filed支持多字段属性。我们在mapping中会看的更加明显</p>
<p><strong>文档（Document）</strong>：文档是可以索引的基本信息单元。ES中的doc就是单条的数据，类似于MySQL上select语句返回的数据。单条订单信息或者单条的学生信息。</p>
<p><strong>映射（mapping）：</strong>ES中的mapping主要存储对应字段的定义，类似表结构（建表SQL）。</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//查询航班信息的mapping</span></span><br><span class="line">GET kibana_sample_data_flights/_mapping</span><br><span class="line"></span><br><span class="line"><span class="comment">//mapping信息</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;kibana_sample_data_flights&quot;</span> : &#123;</span><br><span class="line">    <span class="attr">&quot;mappings&quot;</span> : &#123;</span><br><span class="line">      <span class="attr">&quot;properties&quot;</span> : &#123;</span><br><span class="line">        <span class="attr">&quot;AvgTicketPrice&quot;</span> : &#123; <span class="comment">// 字段属性</span></span><br><span class="line">          <span class="attr">&quot;type&quot;</span> : <span class="string">&quot;float&quot;</span>   <span class="comment">//字段类型</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">&quot;Cancelled&quot;</span> : &#123;</span><br><span class="line">          <span class="attr">&quot;type&quot;</span> : <span class="string">&quot;boolean&quot;</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">&quot;Carrier&quot;</span> : &#123;</span><br><span class="line">          <span class="attr">&quot;type&quot;</span> : <span class="string">&quot;keyword&quot;</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">&quot;Dest&quot;</span> : &#123;</span><br><span class="line">          <span class="attr">&quot;type&quot;</span> : <span class="string">&quot;keyword&quot;</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">&quot;DestAirportID&quot;</span> : &#123;</span><br><span class="line">          <span class="attr">&quot;type&quot;</span> : <span class="string">&quot;keyword&quot;</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">&quot;DestCityName&quot;</span> : &#123;</span><br><span class="line">          <span class="attr">&quot;type&quot;</span> : <span class="string">&quot;keyword&quot;</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">&quot;DestCountry&quot;</span> : &#123;</span><br><span class="line">          <span class="attr">&quot;type&quot;</span> : <span class="string">&quot;keyword&quot;</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">&quot;DestLocation&quot;</span> : &#123;</span><br><span class="line">          <span class="attr">&quot;type&quot;</span> : <span class="string">&quot;geo_point&quot;</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">&quot;DestRegion&quot;</span> : &#123;</span><br><span class="line">          <span class="attr">&quot;type&quot;</span> : <span class="string">&quot;keyword&quot;</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">&quot;DestWeather&quot;</span> : &#123;</span><br><span class="line">          <span class="attr">&quot;type&quot;</span> : <span class="string">&quot;keyword&quot;</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">&quot;DistanceKilometers&quot;</span> : &#123;</span><br><span class="line">          <span class="attr">&quot;type&quot;</span> : <span class="string">&quot;float&quot;</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">&quot;DistanceMiles&quot;</span> : &#123;</span><br><span class="line">          <span class="attr">&quot;type&quot;</span> : <span class="string">&quot;float&quot;</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">&quot;FlightDelay&quot;</span> : &#123;</span><br><span class="line">          <span class="attr">&quot;type&quot;</span> : <span class="string">&quot;boolean&quot;</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">&quot;FlightDelayMin&quot;</span> : &#123;</span><br><span class="line">          <span class="attr">&quot;type&quot;</span> : <span class="string">&quot;integer&quot;</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">&quot;FlightDelayType&quot;</span> : &#123;</span><br><span class="line">          <span class="attr">&quot;type&quot;</span> : <span class="string">&quot;keyword&quot;</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">&quot;FlightNum&quot;</span> : &#123;</span><br><span class="line">          <span class="attr">&quot;type&quot;</span> : <span class="string">&quot;keyword&quot;</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">&quot;FlightTimeHour&quot;</span> : &#123;</span><br><span class="line">          <span class="attr">&quot;type&quot;</span> : <span class="string">&quot;keyword&quot;</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">&quot;FlightTimeMin&quot;</span> : &#123;</span><br><span class="line">          <span class="attr">&quot;type&quot;</span> : <span class="string">&quot;float&quot;</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">&quot;Origin&quot;</span> : &#123;</span><br><span class="line">          <span class="attr">&quot;type&quot;</span> : <span class="string">&quot;keyword&quot;</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">&quot;OriginAirportID&quot;</span> : &#123;</span><br><span class="line">          <span class="attr">&quot;type&quot;</span> : <span class="string">&quot;keyword&quot;</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">&quot;OriginCityName&quot;</span> : &#123;</span><br><span class="line">          <span class="attr">&quot;type&quot;</span> : <span class="string">&quot;keyword&quot;</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">&quot;OriginCountry&quot;</span> : &#123;</span><br><span class="line">          <span class="attr">&quot;type&quot;</span> : <span class="string">&quot;keyword&quot;</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">&quot;OriginLocation&quot;</span> : &#123;</span><br><span class="line">          <span class="attr">&quot;type&quot;</span> : <span class="string">&quot;geo_point&quot;</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">&quot;OriginRegion&quot;</span> : &#123;</span><br><span class="line">          <span class="attr">&quot;type&quot;</span> : <span class="string">&quot;keyword&quot;</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">&quot;OriginWeather&quot;</span> : &#123;</span><br><span class="line">          <span class="attr">&quot;type&quot;</span> : <span class="string">&quot;keyword&quot;</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">&quot;dayOfWeek&quot;</span> : &#123;</span><br><span class="line">          <span class="attr">&quot;type&quot;</span> : <span class="string">&quot;integer&quot;</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">&quot;timestamp&quot;</span> : &#123;</span><br><span class="line">          <span class="attr">&quot;type&quot;</span> : <span class="string">&quot;date&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  j</span><br></pre></td></tr></table></figure>

<h4 id="常用的filed-datatype"><a href="#常用的filed-datatype" class="headerlink" title="常用的filed-datatype"></a>常用的filed-datatype</h4><p>类型（filed-datatype）：filed-datatype 一般是ES存储数据类型，主要针对的是mapping的数据</p>
<p>字符串类型：text，keyword。</p>
<p>text：文本类型,在索引文件中，存储的不是原字符串，而是使用分词器对内容进行分词处理后得到一系列的词根，然后一一存储在index的倒排索引中。</p>
<p>keyword：关键字类型，将原始输入内容当成一个词根存储在倒排索引中，与text字段的区别是该字段不会使用分词器进行分词。</p>
<p>在搜索中如果想使用分词就使用text类型的字符串，如果想精确查找就使用keyword字符串。如果即想分词查找又想精确查找。就使用多字段，外围字段使用text分词查找，内部使用keyword（反过来也可以）</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&quot;firstname&quot; : &#123;</span><br><span class="line">         &quot;type&quot; : &quot;text&quot;,</span><br><span class="line">         &quot;fields&quot; : &#123;</span><br><span class="line">           &quot;keyword&quot; : &#123;</span><br><span class="line">             &quot;type&quot; : &quot;keyword&quot;,</span><br><span class="line">             &quot;ignore_above&quot; : 256</span><br><span class="line">         &#125;</span><br><span class="line">     &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>数字类型：long、integer、short、byte、double、float、half_float、scaled_float。</p>
<p>long、integer、short、byte、double、float这些字段的取值与java一致，毕竟ES底层也是Java写的。</p>
<p>half_float ： 浮点数，但只是用16位</p>
<p>scaled_float ：底层基于long存储，支持一个固定的精度因子。如果存储浮点数0.15,如果设置scaling_fac-tor=100，则该类型会以一个整数15进行存储，有效提高其存储性能。</p>
<p>日期类型（date）：json对象没有日期类型，故java中的日期数据会被格式化。</p>
<ul>
<li>字符串类型，例如”2015-01-01”</li>
<li>数字类型(long)，表示从1970-01-01以来的毫秒数</li>
<li>int类型，表示从1970-01-01以来的秒数</li>
</ul>
<p>布尔类型（boolean）：存储布尔值，true和false。</p>
<p>二进制（binary）：该类型可以用来存储二进制数据，存储之前，需要先用Base64进行编码码。该字段类型默认不存储在索引中(store=fa-sle,但该值还是会存储在_source字段中-)，默认也是不能用来当搜索条件。</p>
<p>数组类型（array）：存储数组信息。可以字符类型，也可以是数字类型。</p>
<p>对象类型（object）：存储对象或json对象字符串。（主要是存储json字符串）</p>
<p>嵌套类型（nested）：存储是对象用于关联查询。</p>
<p>object和nested类型主要是区别是object主要是存储，不能做为关联查询。但是nested在嵌套对象中进行关联查询，在嵌套对象中创建； 倒排索引。</p>
<p>地理信息类型（Geo）：geo_point、geo_shape datatype</p>
<p>地图坐标（geo_point）：存储经纬度。其使用场景：</p>
<ul>
<li><p>Geo Bounding Box Query 找出落在指定矩形框中的坐标点</p>
</li>
<li><p>Geo Distance Query 找出与指定位置在给定距离内的点</p>
</li>
<li><p>找出与指定点距离在给定最小距离和最大)距离之间的点</p>
</li>
<li><p>Geo Polygon Query 查找包含在多边形范围内的文档 与地理位置相关的查询。</p>
</li>
</ul>
<p>地理形状（geo_shape）：数据类型方便了对任意地理形状(如矩形和多边形)进行索引和搜索。当正在索引的数据或正在执行的查询包含除了点以外的形状时应该使用它。</p>
<p>geo相关的类型主要是存储地理信息和地理信息计算。这种数据存储可以在LBS(电子围栏系统)使用，我们常用打车软件中计算点到点位置信息和展示地理位置信息都可以使用ES进行底层数据处理。redis也支持地理信息也可以使用作为计算</p>
<h4 id="查看索引详细信息"><a href="#查看索引详细信息" class="headerlink" title="查看索引详细信息"></a>查看索引详细信息</h4><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//获取银行索引的详细信息</span></span><br><span class="line">GET bank</span><br><span class="line"></span><br><span class="line"><span class="comment">//返回结果</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;bank&quot;</span> : &#123;</span><br><span class="line">    <span class="attr">&quot;aliases&quot;</span> : &#123; &#125;,  <span class="comment">//别名信息</span></span><br><span class="line">    <span class="attr">&quot;mappings&quot;</span> : &#123;  <span class="comment">// mapping信息</span></span><br><span class="line">      <span class="attr">&quot;properties&quot;</span> : &#123;</span><br><span class="line">        <span class="attr">&quot;account_number&quot;</span> : &#123;</span><br><span class="line">          <span class="attr">&quot;type&quot;</span> : <span class="string">&quot;long&quot;</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">&quot;address&quot;</span> : &#123;</span><br><span class="line">          <span class="attr">&quot;type&quot;</span> : <span class="string">&quot;text&quot;</span>, <span class="comment">// 字段属性是文本，支持分词查找，使用默认分词器</span></span><br><span class="line">          <span class="attr">&quot;fields&quot;</span> : &#123; <span class="comment">//  多字段属性 </span></span><br><span class="line">            <span class="attr">&quot;keyword&quot;</span> : </span><br><span class="line">              <span class="string">&quot;type&quot;</span> : <span class="string">&quot;keyword&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;ignore_above&quot;</span> : <span class="number">256</span></span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">&quot;age&quot;</span> : &#123;</span><br><span class="line">          <span class="attr">&quot;type&quot;</span> : <span class="string">&quot;long&quot;</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">&quot;balance&quot;</span> : &#123;</span><br><span class="line">          <span class="attr">&quot;type&quot;</span> : <span class="string">&quot;long&quot;</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">&quot;city&quot;</span> : &#123;</span><br><span class="line">          <span class="attr">&quot;type&quot;</span> : <span class="string">&quot;text&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;fields&quot;</span> : &#123;</span><br><span class="line">            <span class="attr">&quot;keyword&quot;</span> : &#123;</span><br><span class="line">              <span class="attr">&quot;type&quot;</span> : <span class="string">&quot;keyword&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;ignore_above&quot;</span> : <span class="number">256</span></span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">&quot;email&quot;</span> : &#123;</span><br><span class="line">          <span class="attr">&quot;type&quot;</span> : <span class="string">&quot;text&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;fields&quot;</span> : &#123;</span><br><span class="line">            <span class="attr">&quot;keyword&quot;</span> : &#123;</span><br><span class="line">              <span class="attr">&quot;type&quot;</span> : <span class="string">&quot;keyword&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;ignore_above&quot;</span> : <span class="number">256</span></span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">&quot;employer&quot;</span> : &#123;</span><br><span class="line">          <span class="attr">&quot;type&quot;</span> : <span class="string">&quot;text&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;fields&quot;</span> : &#123;</span><br><span class="line">            <span class="attr">&quot;keyword&quot;</span> : &#123;</span><br><span class="line">              <span class="attr">&quot;type&quot;</span> : <span class="string">&quot;keyword&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;ignore_above&quot;</span> : <span class="number">256</span></span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">&quot;firstname&quot;</span> : &#123;</span><br><span class="line">          <span class="attr">&quot;type&quot;</span> : <span class="string">&quot;text&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;fields&quot;</span> : &#123;</span><br><span class="line">            <span class="attr">&quot;keyword&quot;</span> : &#123;</span><br><span class="line">              <span class="attr">&quot;type&quot;</span> : <span class="string">&quot;keyword&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;ignore_above&quot;</span> : <span class="number">256</span></span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">&quot;gender&quot;</span> : &#123;</span><br><span class="line">          <span class="attr">&quot;type&quot;</span> : <span class="string">&quot;text&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;fields&quot;</span> : &#123;</span><br><span class="line">            <span class="attr">&quot;keyword&quot;</span> : &#123;</span><br><span class="line">              <span class="attr">&quot;type&quot;</span> : <span class="string">&quot;keyword&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;ignore_above&quot;</span> : <span class="number">256</span></span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">&quot;lastname&quot;</span> : &#123;</span><br><span class="line">          <span class="attr">&quot;type&quot;</span> : <span class="string">&quot;text&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;fields&quot;</span> : &#123;</span><br><span class="line">            <span class="attr">&quot;keyword&quot;</span> : &#123;</span><br><span class="line">              <span class="attr">&quot;type&quot;</span> : <span class="string">&quot;keyword&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;ignore_above&quot;</span> : <span class="number">256</span></span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">&quot;state&quot;</span> : &#123;</span><br><span class="line">          <span class="attr">&quot;type&quot;</span> : <span class="string">&quot;text&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;fields&quot;</span> : &#123;</span><br><span class="line">            <span class="attr">&quot;keyword&quot;</span> : &#123;</span><br><span class="line">              <span class="attr">&quot;type&quot;</span> : <span class="string">&quot;keyword&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;ignore_above&quot;</span> : <span class="number">256</span></span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">&quot;settings&quot;</span> : &#123;  <span class="comment">//索引的设置信息</span></span><br><span class="line">      <span class="attr">&quot;index&quot;</span> : &#123;</span><br><span class="line">        <span class="attr">&quot;creation_date&quot;</span> : <span class="string">&quot;1663750625000&quot;</span>, <span class="comment">//创建时间</span></span><br><span class="line">        <span class="attr">&quot;number_of_shards&quot;</span> : <span class="string">&quot;1&quot;</span>,  <span class="comment">//分片个数</span></span><br><span class="line">        <span class="attr">&quot;number_of_replicas&quot;</span> : <span class="string">&quot;0&quot;</span>, <span class="comment">//副本个数</span></span><br><span class="line">        <span class="attr">&quot;uuid&quot;</span> : <span class="string">&quot;wC0eRZocScGU9n2OxEV6uA&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;version&quot;</span> : &#123;</span><br><span class="line">          <span class="attr">&quot;created&quot;</span> : <span class="string">&quot;7060099&quot;</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">&quot;provided_name&quot;</span> : <span class="string">&quot;bank&quot;</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="倒排索引"><a href="#倒排索引" class="headerlink" title="倒排索引"></a>倒排索引</h3><p><strong>正排索引</strong>：(index)正排表是以文档的ID为key，表中记录文档中每个关键字的位置信息，查找时扫描表中每个文档中字的信息直到找出所有包含查询关键字的文档。也就是普通索引</p>
<p><img src="https://raw.githubusercontent.com/ClaudeWilliam/pic-blog/master/imgindex.png"></p>
<p>item就是具体的数据，keyword就是对应的字段和关键字，根据item信息去查询全部具体数据，这种更像是字典或者书籍的目录，也就是从这种就是正排索引</p>
<p><img src="https://raw.githubusercontent.com/ClaudeWilliam/pic-blog/master/img%E5%BE%AE%E4%BF%A1%E6%88%AA%E5%9B%BE_20230114202238.png"></p>
<p><strong>倒排索引</strong>：(Inverted index)也常被称为反向索引、置入档案或反向档案，是一种索引方法，被用来存储在全文搜索下某个单词在一个文档或者一组文档中的存储位置的映射，它是文档检索系统中最常用的数据结构。</p>
<p><img src="https://raw.githubusercontent.com/ClaudeWilliam/pic-blog/master/imgInverte-%20index.png"></p>
<p>倒排索引更像书中的索引页，根据对应的keyword去查询具体的数据，一个keyword可能会在多个item中。</p>
<p><img src="https://raw.githubusercontent.com/ClaudeWilliam/pic-blog/master/img%E5%BE%AE%E4%BF%A1%E6%88%AA%E5%9B%BE_20230114202252.png"></p>
<h3 id="ElasticSearch的高可用与扩展"><a href="#ElasticSearch的高可用与扩展" class="headerlink" title="ElasticSearch的高可用与扩展"></a>ElasticSearch的高可用与扩展</h3><p>ElasticSearch是一个分布式、可扩展、近实时的搜索和数据分析系统系统，上面解释关于名称索引还有倒排索引，这部分解释一些关于ES集群的一些名称和配置。一般正常在生成环境中部署的都是ElasticSearch的集群，一般集群就意味着高可用和可扩展（否则用单体会是更好的选择）</p>
<h4 id="集群（cluster）"><a href="#集群（cluster）" class="headerlink" title="集群（cluster）"></a>集群（cluster）</h4><p>ES的集群搭建很简单，不需要依赖第三方协调管理组件，自身内部就实现了集群的管理功能。ES集群由一个或多个Elasticsearch节点组成，每个节点配置相同的 <code>cluster.name</code> 即可加入集群，默认值为 <code>my-application</code>。确保不同的环境中使用不同的集群名称，否则最终会导致节点加入错误的集群。</p>
<p>elasticsearch.yml 中Cluster的配置</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ---------------------------------- Cluster -----------------------------------</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Use a descriptive name for your cluster:</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">#cluster.name: my-application</span></span><br><span class="line">cluster.name: cluster</span><br><span class="line"><span class="comment">#</span></span><br></pre></td></tr></table></figure>

<p>Node可以理解为启动的ElasticSearch的单个实例。节点通过 <code>node.name</code> 来设置节点名称，如果不设置则在启动时给节点分配一个随机通用唯一标识符作为名称。ElasticSearch的自动发现机制，当配置相同的<code>cluster.name</code>会被加入相同的集群。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ------------------------------------ Node ------------------------------------</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Use a descriptive name for the node:</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">#node.name: node-1</span></span><br><span class="line">node.name: node-1</span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Add custom attributes to the node:</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">#node.attr.rack: r1</span></span><br><span class="line">node.master: <span class="literal">true</span></span><br><span class="line">node.data: <span class="literal">true</span></span><br></pre></td></tr></table></figure>

<p>在节点可以指定节点属性，候选主节点和数据节点。通过<code>node.master</code>指定候选主节点，通过<code>node.data</code>指定是否为数据节点。默认都为true。</p>
<p><strong>数据节点</strong>： 负责数据的存储和相关的操作，例如对数据进行增、删、改、查和聚合等操作，所以数据节点（data节点）对机器配置要求比较高，对CPU、内存和I/O的消耗很大。通常随着集群的扩大，需要增加更多的数据节点来提高性能和可用性。</p>
<p><strong>候选主节点</strong> ：可以被选举为主节点（master节点），集群中只有候选主节点才有选举权和被选举权，其他节点不参与选举的工作<strong>。主节点负责创建索引、删除索引、跟踪哪些节点是群集的一部分，并决定哪些分片分配给相关的节点、追踪集群中节点的状态等，稳定的主节点对集群的健康是非常重要的。</strong></p>
<p><strong>协调节点</strong>：负责分发请求、收集结果等操作，而不需要主节点转发。虽然对节点做了角色区分，但是用户的请求可以发往任何一个节点。协调节点是不需要指定和配置的，集群中的任何节点都可以充当协调节点的角色。（协调节点也有被称为客户端节点）</p>
<p>一个节点既可以是候选主节点也可以是数据节点，但是由于数据节点对CPU、内存核I/0消耗都很大，所以如果某个节点既是数据节点又是主节点，那么可能会对主节点产生影响从而对整个集群的状态产生影响。</p>
<p>因此为了提高集群的健康性，我们应该对Elasticsearch集群中的节点做好角色上的划分和隔离。可以使用几个配置较低的机器群作为候选主节点群。主节点和其他节点之间通过Ping的方式互检查，主节点负责Ping所有其他节点，判断是否有节点已经挂掉。其他节点也通过Ping的方式判断主节点是否处于可用状态。</p>
<p><img src="https://raw.githubusercontent.com/ClaudeWilliam/pic-blog/master/imges%E9%9B%86%E7%BE%A4.drawio.png"></p>
<p>如果由于网络或其他原因导致集群中选举出多个Master节点，使得数据更新时出现不一致，这种现象称之为集群脑裂（Cluster Split Brain）。 集群中的一些节点认为其他节点已经下线，并开始独立地运行，而不是作为集群中的一个整体运行，导致集群的不可用。</p>
<p><strong>脑裂</strong>可能由以下几个原因造成：</p>
<ul>
<li><p>网络问题：集群间的网络延迟导致一些节点访问不到master，认为master挂掉了从而选举出新的master，并对master上的分片和副本标红，分配新的主分片</p>
</li>
<li><p>节点负载：主节点的角色既为master又为data，访问量较大时可能会导致ES停止响应（假死状态）造成大面积延迟，此时其他节点得不到主节点的响应认为主节点挂掉了，会重新选取主节点。</p>
</li>
<li><p>内存回收：主节点的角色既为master又为data，当data节点上的ES进程占用的内存较大，引发JVM的大规模内存回收，造成ES进程失去响应。</p>
</li>
</ul>
<p>为了避免脑裂现象的发生，我们可以从原因着手通过以下几个方面来做出优化措施：</p>
<ul>
<li><p>适当调大响应时间，减少误判。通过参数<code>discovery.zen.ping_timeout</code>设置节点状态的响应时间，默认为3s，可以适当调大，如果master在该响应时间的范围内没有做出响应应答，判断该节点已经挂掉了。调大参数（如6s，<code>discovery.zen.ping_timeout:6</code>），可适当减少误判。</p>
</li>
<li><p>选举触发，在候选集群中的节点的配置文件中设置参数<code>discovery.zen.munimum_master_nodes</code>的值，这个参数表示在选举主节点时需要参与选举的候选主节点的节点数，默认值是1，官方建议取值(master_eligibel_nodes/2) + 1，其中<code>master_eligibel_nodes</code>为候选主节点的个数。这样做既能防止脑裂现象的发生，也能最大限度地提升集群的高可用性，因为只要不少于<code>discovery.zen.munimum_master_nodes</code>个候选节点存活，选举工作就能正常进行。当小于这个值的时候，无法触发选举行为，集群无法使用，不会造成分片混乱的情况。</p>
</li>
<li><p>角色分离，候选主节点和数据节点进行角色分离，这样可以减轻主节点的负担，防止主节点的假死状态发生，减少对主节点“已死”的误判。</p>
</li>
</ul>
<h4 id="分片（shards）"><a href="#分片（shards）" class="headerlink" title="分片（shards）"></a>分片（shards）</h4><p> 当索引上的数据量太大的时候，ES通过水平拆分的方式将一个索引上的数据拆分出来分配到不同的数据块上，拆分出来的数据库块称之为一个 <strong>分片</strong> 。</p>
<p>在一个多分片的索引中写入数据时，通过路由来确定具体写入哪一个分片中，所以在创建索引的时候需要指定分片的数量，并且分片的数量一旦确定就不能修改。</p>
<p>使用分片可以，水平分割/缩放内容，提高扩展能力。在分片（可能在多个节点上）分布和并行操作，从而提高性能/吞吐量。</p>
<p>分片的数量和下面介绍的副本数量都是可以通过创建索引时的<code>settings</code>来配置</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//查询分片和副本的配置信息</span></span><br><span class="line">GET myIndex/_settings</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;myIndex&quot;</span> : &#123;</span><br><span class="line">    <span class="attr">&quot;settings&quot;</span> : &#123;</span><br><span class="line">      <span class="attr">&quot;index&quot;</span> : &#123;</span><br><span class="line">        <span class="attr">&quot;creation_date&quot;</span> : <span class="string">&quot;1663750625000&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;number_of_shards&quot;</span> : <span class="string">&quot;1&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;number_of_replicas&quot;</span> : <span class="string">&quot;0&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;uuid&quot;</span> : <span class="string">&quot;wC0eRZocScGU9n2OxEV6uA&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;version&quot;</span> : &#123;</span><br><span class="line">          <span class="attr">&quot;created&quot;</span> : <span class="string">&quot;7060099&quot;</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">&quot;provided_name&quot;</span> : <span class="string">&quot;myIndex&quot;</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//设置分片和副本的数量</span></span><br><span class="line">PUT /myIndex</span><br><span class="line">&#123;</span><br><span class="line">   <span class="attr">&quot;settings&quot;</span> : &#123;</span><br><span class="line">      <span class="attr">&quot;number_of_shards&quot;</span> : <span class="number">5</span>,</span><br><span class="line">      <span class="attr">&quot;number_of_replicas&quot;</span> : <span class="number">1</span></span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>查看分片信息</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">GET _cat&#x2F;shards?v</span><br><span class="line"></span><br><span class="line">index                        shard prirep state       docs   store ip        node</span><br><span class="line">read_me                      0     p      STARTED        1   4.4kb 10.0.12.5 node-1</span><br><span class="line">kibana_sample_data_ecommerce 0     p      STARTED     4675   4.9mb 10.0.12.5 node-1</span><br><span class="line">.kibana_task_manager_1       0     p      STARTED        2  21.6kb 10.0.12.5 node-1</span><br><span class="line">test                         0     p      STARTED        1   3.7kb 10.0.12.5 node-1</span><br><span class="line">.kibana_1                    0     p      STARTED        1     4kb 10.0.12.5 node-1</span><br><span class="line">bank                         0     p      STARTED     1000 414.8kb 10.0.12.5 node-1</span><br><span class="line">products                     0     p      STARTED        3   4.3kb 10.0.12.5 node-1</span><br><span class="line">products                     0     r      UNASSIGNED                         </span><br><span class="line">kibana_sample_data_logs      0     p      STARTED    14074  11.2mb 10.0.12.5 node-1</span><br><span class="line">.tasks                       0     p      STARTED        1   6.3kb 10.0.12.5 node-1</span><br><span class="line">.security-7                  0     p      STARTED       42  76.9kb 10.0.12.5 node-1</span><br><span class="line">.apm-agent-configuration     0     p      STARTED        0    283b 10.0.12.5 node-1</span><br><span class="line">kibana_sample_data_flights   0     p      STARTED    13059   6.4mb 10.0.12.5 node-1</span><br><span class="line">.kibana_2                    0     p      STARTED      203   1.1mb 10.0.12.5 node-1</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">index：索引名称 	shard：分片数 	prirep：分片类型，p&#x3D;pri&#x3D;primary为主分片，r&#x3D;rep&#x3D;replicas为复制分片 </span><br><span class="line">state：分片状态	STARTED为正常分片，INITIALIZING为异常分片 	docs：记录数 	store：存储大小 </span><br><span class="line">ip：es节点ip 	node：es节点名称</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="副本（replica）"><a href="#副本（replica）" class="headerlink" title="副本（replica）"></a>副本（replica）</h4><p>副本是分片的复制。如果分片/节点出现故障，副本可以提供数据的查询等操作，提供高可用性，并且通过对所有副本并行执行搜索，扩展搜索量/吞吐量。每个主分片都有一个或多个副本分片。主分片和对应的副本分片是不会在同一个节点上的，所以副本分片数的最大值是 n -1（其中n为节点数）。</p>
<p>默认情默认情况下，ElasticSearch中的每个索引都分配了5个主分片和1个副本况下，ElasticSearch中的每个索引都分配了5个主分片和1个副本。创建索引后，您可以随时动态更改副本数，但不能更改主分片数。</p>
<p>文档的新建、索引和删除请求都是写操作。这些操作都是先在主分片中存储，然后在并发的同步给其他分片，在并发同步数据的过程中为了保证数据的准确性，ES引入乐观锁。ES在每次同步的数据中增加版本号<code>_version</code>，在数据被修改后版本递增，当所有副本都同步完之后在通知协调节点，操作成功，然后协调节点在向客户端同步操作成功数据。</p>
<p><img src="https://raw.githubusercontent.com/ClaudeWilliam/pic-blog/master/imges-10.jpg"></p>
<p>node1 为协调节点，P0和P1是主分片，R0和R1副本。</p>
<p>1、customer向node1提交P0分片的写数据。</p>
<p>2、node1节点作为协调节点，向P0分片的节点发送处理数据，node3节点将P0的数据保存到主分片。</p>
<p>3、node3节点保存完主分片数据，向node2节点和node1节点的R0副本并发同步数据。</p>
<p>最后通知给node1节点操作完成，然后告知customer</p>
<h4 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h4><ul>
<li>将数据分片是为了提高可处理数据的容量和易于进行水平扩展，为分片做副本是为了提高集群的稳定性和提高并发量。</li>
<li>副本是乘法，越多消耗越大，但也越保险。分片是除法，分片越多，单分片数据就越少也越分散。</li>
<li>副本越多，集群的可用性就越高，但是由于每个分片都相当于一个Lucene的索引文件，会占用一定的文件句柄、内存及CPU，并且分片间的数据同步也会占用一定的网络带宽，所以索引的分片数和副本数也不是越多越好</li>
</ul>
<h3 id="ElasticSearch的搜索方式"><a href="#ElasticSearch的搜索方式" class="headerlink" title="ElasticSearch的搜索方式"></a>ElasticSearch的搜索方式</h3><h4 id="URI-API-Search"><a href="#URI-API-Search" class="headerlink" title="URI API Search"></a><strong>URI API Search</strong></h4><p>搜索<code>movies</code>索引中，对tile字段查询2012，排序字段是year倒排，分页从0到10第一页，查询超时时间是1s。</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GET /movies/_search?q=2012&amp;df=title&amp;sort=year:desc&amp;from=0&amp;size=10&amp;timeout=1s</span><br></pre></td></tr></table></figure>

<ul>
<li>q 指定查询语句，使用 query string syntax</li>
<li>df 默认字段，不指定是会对所有字段进行查询</li>
<li>sort 排序 / from 和 size 用于分页</li>
<li>profile 可以查看查询是如何被执行的</li>
</ul>
<h4 id="DSL-Search-API"><a href="#DSL-Search-API" class="headerlink" title="DSL Search API"></a><strong>DSL Search API</strong></h4><p>查询<code>kibana_sample_data_ecommerce</code> 索引全部数据，根据order_date时间倒序排序</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">GET kibana_sample_data_ecommerce/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;sort&quot;</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">&quot;order_date&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">&quot;order&quot;</span>: <span class="string">&quot;desc&quot;</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  ], </span><br><span class="line">  <span class="attr">&quot;query&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;match_all&quot;</span>: &#123;</span><br><span class="line">      </span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在实际生成当中使用DSL Search API的时候更多，因为DSL支持的语法和优化更多，而是可以通过</p>
<h3 id="ES的搜索查询类型"><a href="#ES的搜索查询类型" class="headerlink" title="ES的搜索查询类型"></a>ES的搜索查询类型</h3><h4 id="词项查询（Term-queries）"><a href="#词项查询（Term-queries）" class="headerlink" title="词项查询（Term queries）"></a>词项查询（Term queries）</h4><p><strong>Term</strong>（词项/条）：term是表达语义最小单位，搜索和利用统计语言模型进行自然语言处理都需要处理term。</p>
<p>ES 中 对term 查询对输入不做分词，会将输入作为整体，在倒排索引中查找准确的词项，并且使用相关度算分公式每个包含该词项的文档进行算分，返回的文档会根据算分结果进行排序一般相关度高的会排在前面。注意，由于term查询是不做分词，一般使用的filed-datatype是keyword，而不是text类型，text在存储的时候会进行分词，在使用term的等值查询的时候查询不到数据。</p>
<p><strong>Term Level Query</strong> ：Term Query（词项等值查询） 、Range Query（词项的范围查找）、Exists Query（词项的存在查找）、Perfix Query（词项的前缀查找）、WildCard Query（词项的通配符查找，WildCard  扑克牌的万能牌）。</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Term Query  查询飞往中国的航班 返回对应文档数据</span></span><br><span class="line">GET /kibana_sample_data_flights/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;query&quot;</span>:&#123;</span><br><span class="line">    <span class="attr">&quot;term&quot;</span>:&#123;</span><br><span class="line">       <span class="attr">&quot;DestCountry&quot;</span>:&#123;</span><br><span class="line">         <span class="attr">&quot;value&quot;</span>:<span class="string">&quot;CH&quot;</span></span><br><span class="line">       &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//或者不使用value直接使用的相等，返回对应的文档数据</span></span><br><span class="line">GET /kibana_sample_data_flights/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;query&quot;</span>:&#123;</span><br><span class="line">    <span class="attr">&quot;term&quot;</span>:&#123;</span><br><span class="line">       <span class="attr">&quot;DestCountry&quot;</span>:<span class="string">&quot;CH&quot;</span></span><br><span class="line">       &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//Range Query 查询机票价格大于500 小于1000</span></span><br><span class="line">GET kibana_sample_data_flights/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;query&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;constant_score&quot;</span>: &#123;</span><br><span class="line">      <span class="attr">&quot;filter&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">&quot;range&quot;</span>: &#123;</span><br><span class="line">          <span class="attr">&quot;AvgTicketPrice&quot;</span>: &#123;</span><br><span class="line">            <span class="attr">&quot;gte&quot;</span>:  <span class="number">500</span>,</span><br><span class="line">            <span class="attr">&quot;lte&quot;</span>: <span class="number">1000</span></span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//Exists Query 是否存在字段 返回包含这个字段的文档</span></span><br><span class="line">GET /kibana_sample_data_flights/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;query&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;exists&quot;</span>: &#123;</span><br><span class="line">      <span class="attr">&quot;field&quot;</span>: <span class="string">&quot;DestCountry&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//Perfix Query 前缀查找 匹配所有目的地是C开头的文档 返回包含这个字段的文档</span></span><br><span class="line">GET /kibana_sample_data_flights/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;query&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;prefix&quot;</span>: &#123;</span><br><span class="line">      <span class="attr">&quot;DestCountry&quot;</span>: <span class="string">&quot;C&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//WildCard Query 通配符查找 匹配1开通1结尾的航班号 指定返回_score得分为1.0</span></span><br><span class="line">GET /kibana_sample_data_flights/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;query&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;wildcard&quot;</span>: &#123;</span><br><span class="line">      <span class="attr">&quot;FlightNum&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">&quot;value&quot;</span>: <span class="string">&quot;1*1&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;boost&quot;</span>: <span class="number">1.0</span>,</span><br><span class="line">        <span class="attr">&quot;rewrite&quot;</span>: <span class="string">&quot;constant_score&quot;</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// boost 权重当</span></span><br></pre></td></tr></table></figure>

<h4 id="全文本查询（Full-text-queries）"><a href="#全文本查询（Full-text-queries）" class="headerlink" title="全文本查询（Full text queries）"></a>全文本查询（Full text queries）</h4><p>分词匹配搜索：通常用于搜索文本字段，需要用户提供关键字来完成。搜索时候会进行分词，查询字符串会先传递给一个分词器进行分词。然后生成一个提供查询的词项列表。然后每个词项逐个的进行底层查询，最终将结果进行合并，并为每个文档进行算分，最后根据算分结果给出排序。例如查询matrix reloaded 会查询包括 matrix和reload的所有结果。</p>
<p>总结一下就是这个查询分两步。首先是分词，通过分词器将查询的关键词分词（这个可以手动指定也可以自动指定）。然后将分词好的term（词项）列表去通过term查询查找（底层还是term查找），然后算分排序返回。全文本搜索一般使用text类型的字段，因为text类型的字段在存储过程中就已经被分词，这里推荐在创建索引和查询时使用同样的分词器。因为分词的使用可能会有不同的偏差导致查询不到具体数据。</p>
<p>常见的ES中的分词器有<code>standard</code>、<code>simple</code>、<code>pattern</code>、<code>keyword</code>、<code>english</code>；中文的分词器有<code>ik_smart</code>、<code>ik_max_word</code>、<code>icu_analyzer</code>默认ES中时没有中文分词器中文的分词器需要自己在插件中安装。安装方法自己去Google吧</p>
<p>使用分词器分词示例</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">GET _analyze </span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;analyzer&quot;</span>: <span class="string">&quot;standard&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;text&quot;</span>: [<span class="string">&quot;2 bird flying in the sky &quot;</span>]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">GET _analyze</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;analyzer&quot;</span>: <span class="string">&quot;simple&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;text&quot;</span>: [<span class="string">&quot;2 bird flying in the sky &quot;</span>]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">GET _analyze</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;analyzer&quot;</span>: <span class="string">&quot;keyword&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;text&quot;</span>: [<span class="string">&quot;2 running Quick brown-foxes leap over lazy dogs in the  summmer evening &quot;</span>]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">GET _analyze</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;analyzer&quot;</span>: <span class="string">&quot;pattern&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;text&quot;</span>: [<span class="string">&quot;2 running Quick brown-foxes leap over lazy dogs in the  summmer evening &quot;</span>]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">GET _analyze</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;analyzer&quot;</span>: <span class="string">&quot;english&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;text&quot;</span>: [<span class="string">&quot;2 running Quick brown-foxes leap over lazy dogs in the  summmer evening &quot;</span>]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">GET _analyze</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;analyzer&quot;</span>: <span class="string">&quot;icu_analyzer&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;text&quot;</span>: [<span class="string">&quot;他说的确实在理&quot;</span>]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">GET _analyze</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;analyzer&quot;</span>: <span class="string">&quot;ik_smart&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;text&quot;</span>: [<span class="string">&quot;他说的确实在理&quot;</span>]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">GET _analyze</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;analyzer&quot;</span>: <span class="string">&quot;ik_max_word&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;text&quot;</span>: [<span class="string">&quot;他说的确实在理&quot;</span>]</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//想要看具体的分词结果就可以在kibana上执行</span></span><br></pre></td></tr></table></figure>

<p><strong>Macth Query Level</strong>：Match Query （分词匹配查询）/ Match Phrase Query（分词短语匹配查询）/ Query String Query（字符串查询）/ Multi Match Query（多字段分词匹配查询）</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//Match Query 查询customer_full_name为 Eddie Underwood数据，返回customer_full_name存在Eddie和Underwood的数据 这里面Eddie 和 Underwood 分词是or的关系</span></span><br><span class="line">GET kibana_sample_data_ecommerce/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;query&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;match&quot;</span>: &#123;</span><br><span class="line">      <span class="attr">&quot;customer_full_name&quot;</span>: <span class="string">&quot;Eddie Underwood&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//Match Query 返回Eddie Underwood 直接关系是and的数据，还可以指定分词器analyzer和minimum_should_match最小匹配数</span></span><br><span class="line">GET kibana_sample_data_ecommerce/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;query&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;match&quot;</span>: &#123;</span><br><span class="line">      <span class="attr">&quot;customer_full_name&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">&quot;query&quot;</span>: <span class="string">&quot;Eddie Underwood&quot;</span>, </span><br><span class="line">        <span class="attr">&quot;operator&quot;</span>: <span class="string">&quot;and&quot;</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Match Phrase Query 是对Match Query的升级分词后所有词项都要出现，在该字段中字段中所有的词项顺序要一致</span></span><br><span class="line">GET kibana_sample_data_ecommerce/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;query&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;match_phrase&quot;</span>: &#123;</span><br><span class="line">      <span class="attr">&quot;customer_full_name&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">&quot;query&quot;</span>: <span class="string">&quot;Eddie Underwood&quot;</span></span><br><span class="line">      &#125;</span><br><span class="line">   &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//Query String Query  在字符串中指定逻辑，返回category字段中包含Clothing或者Shoes的数据</span></span><br><span class="line">GET kibana_sample_data_ecommerce/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;query&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;query_string&quot;</span>: &#123;</span><br><span class="line">     <span class="attr">&quot;query&quot;</span>: <span class="string">&quot;(Clothing) OR (Shoes)&quot;</span>,</span><br><span class="line">     <span class="attr">&quot;default_field&quot;</span>: <span class="string">&quot;category&quot;</span></span><br><span class="line">   &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// Multi Match Query  查询category或者customer_full_name字段存在King的数据。</span></span><br><span class="line">GET kibana_sample_data_ecommerce/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;query&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;multi_match&quot;</span>: &#123;</span><br><span class="line">      <span class="attr">&quot;query&quot;</span>: <span class="string">&quot;King&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;fields&quot;</span>: [<span class="string">&quot;category&quot;</span>,<span class="string">&quot;customer_full_name&quot;</span>]</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="复合查询（Compound-queries-）"><a href="#复合查询（Compound-queries-）" class="headerlink" title="复合查询（Compound queries ）"></a>复合查询（Compound queries ）</h4><p><strong>复合查询</strong>：复合查询就是将一些简单的查询组合在一起作为查询条件进行文档检索。</p>
<p><strong>相关性算分</strong>（Relevance Score）：搜索的相关性算分，是描述一个文档和查询语句的匹配程度，ES会对每个匹配的查询条件的结果进行算分_score，算分的本质是ES会把返回结果根据算分的高低进行排序，一般排在最前面的都是相关性高的。ES5.0之前使用的是TF-IDF算法进行算分，后面的版本优化使用BM25(Best Match)算法进行算分。</p>
<p>使用<code>explain</code>可以查看ES算分过程，这个和MySQL看执行计划是一样的。</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br></pre></td><td class="code"><pre><span class="line">GET kibana_sample_data_ecommerce/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;explain&quot;</span>: <span class="literal">true</span>, </span><br><span class="line">  <span class="attr">&quot;query&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;match_phrase&quot;</span>: &#123;</span><br><span class="line">      <span class="attr">&quot;customer_full_name&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">&quot;query&quot;</span>: <span class="string">&quot;Eddie Underwood&quot;</span></span><br><span class="line">      &#125;</span><br><span class="line">   &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//执行结果</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;took&quot;</span> : <span class="number">1</span>,</span><br><span class="line">  <span class="attr">&quot;timed_out&quot;</span> : <span class="literal">false</span>,</span><br><span class="line">  <span class="attr">&quot;_shards&quot;</span> : &#123;</span><br><span class="line">    <span class="attr">&quot;total&quot;</span> : <span class="number">1</span>,</span><br><span class="line">    <span class="attr">&quot;successful&quot;</span> : <span class="number">1</span>,</span><br><span class="line">    <span class="attr">&quot;skipped&quot;</span> : <span class="number">0</span>,</span><br><span class="line">    <span class="attr">&quot;failed&quot;</span> : <span class="number">0</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">&quot;hits&quot;</span> : &#123;</span><br><span class="line">    <span class="attr">&quot;total&quot;</span> : &#123;</span><br><span class="line">      <span class="attr">&quot;value&quot;</span> : <span class="number">1</span>,</span><br><span class="line">      <span class="attr">&quot;relation&quot;</span> : <span class="string">&quot;eq&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">&quot;max_score&quot;</span> : <span class="number">8.399749</span>,</span><br><span class="line">    <span class="attr">&quot;hits&quot;</span> : [</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">&quot;_shard&quot;</span> : <span class="string">&quot;[kibana_sample_data_ecommerce][0]&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;_node&quot;</span> : <span class="string">&quot;vj8gacmkRCS9gh9d9tassw&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;_index&quot;</span> : <span class="string">&quot;kibana_sample_data_ecommerce&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;_type&quot;</span> : <span class="string">&quot;_doc&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;_id&quot;</span> : <span class="string">&quot;FHbQXoMB7xzzV5IgPJqV&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;_score&quot;</span> : <span class="number">8.399749</span>,</span><br><span class="line">        <span class="attr">&quot;_source&quot;</span> : &#123;</span><br><span class="line">          <span class="attr">&quot;category&quot;</span> : [</span><br><span class="line">            <span class="string">&quot;Men&#x27;s Clothing&quot;</span></span><br><span class="line">          ],</span><br><span class="line">          <span class="attr">&quot;currency&quot;</span> : <span class="string">&quot;EUR&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;customer_first_name&quot;</span> : <span class="string">&quot;Eddie&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;customer_full_name&quot;</span> : <span class="string">&quot;Eddie Underwood&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;customer_gender&quot;</span> : <span class="string">&quot;MALE&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;customer_id&quot;</span> : <span class="number">38</span>,</span><br><span class="line">          <span class="attr">&quot;customer_last_name&quot;</span> : <span class="string">&quot;Underwood&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;customer_phone&quot;</span> : <span class="string">&quot;&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;day_of_week&quot;</span> : <span class="string">&quot;Monday&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;day_of_week_i&quot;</span> : <span class="number">0</span>,</span><br><span class="line">          <span class="attr">&quot;email&quot;</span> : <span class="string">&quot;eddie@underwood-family.zzz&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;manufacturer&quot;</span> : [</span><br><span class="line">            <span class="string">&quot;Elitelligence&quot;</span>,</span><br><span class="line">            <span class="string">&quot;Oceanavigations&quot;</span></span><br><span class="line">          ],</span><br><span class="line">          <span class="attr">&quot;order_date&quot;</span> : <span class="string">&quot;2022-10-03T09:28:48+00:00&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;order_id&quot;</span> : <span class="number">584677</span>,</span><br><span class="line">          <span class="attr">&quot;products&quot;</span> : [</span><br><span class="line">            &#123;</span><br><span class="line">              <span class="attr">&quot;base_price&quot;</span> : <span class="number">11.99</span>,</span><br><span class="line">              <span class="attr">&quot;discount_percentage&quot;</span> : <span class="number">0</span>,</span><br><span class="line">              <span class="attr">&quot;quantity&quot;</span> : <span class="number">1</span>,</span><br><span class="line">              <span class="attr">&quot;manufacturer&quot;</span> : <span class="string">&quot;Elitelligence&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;tax_amount&quot;</span> : <span class="number">0</span>,</span><br><span class="line">              <span class="attr">&quot;product_id&quot;</span> : <span class="number">6283</span>,</span><br><span class="line">              <span class="attr">&quot;category&quot;</span> : <span class="string">&quot;Men&#x27;s Clothing&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;sku&quot;</span> : <span class="string">&quot;ZO0549605496&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;taxless_price&quot;</span> : <span class="number">11.99</span>,</span><br><span class="line">              <span class="attr">&quot;unit_discount_amount&quot;</span> : <span class="number">0</span>,</span><br><span class="line">              <span class="attr">&quot;min_price&quot;</span> : <span class="number">6.35</span>,</span><br><span class="line">              <span class="attr">&quot;_id&quot;</span> : <span class="string">&quot;sold_product_584677_6283&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;discount_amount&quot;</span> : <span class="number">0</span>,</span><br><span class="line">              <span class="attr">&quot;created_on&quot;</span> : <span class="string">&quot;2016-12-26T09:28:48+00:00&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;product_name&quot;</span> : <span class="string">&quot;Basic T-shirt - dark blue/white&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;price&quot;</span> : <span class="number">11.99</span>,</span><br><span class="line">              <span class="attr">&quot;taxful_price&quot;</span> : <span class="number">11.99</span>,</span><br><span class="line">              <span class="attr">&quot;base_unit_price&quot;</span> : <span class="number">11.99</span></span><br><span class="line">            &#125;,</span><br><span class="line">            &#123;</span><br><span class="line">              <span class="attr">&quot;base_price&quot;</span> : <span class="number">24.99</span>,</span><br><span class="line">              <span class="attr">&quot;discount_percentage&quot;</span> : <span class="number">0</span>,</span><br><span class="line">              <span class="attr">&quot;quantity&quot;</span> : <span class="number">1</span>,</span><br><span class="line">              <span class="attr">&quot;manufacturer&quot;</span> : <span class="string">&quot;Oceanavigations&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;tax_amount&quot;</span> : <span class="number">0</span>,</span><br><span class="line">              <span class="attr">&quot;product_id&quot;</span> : <span class="number">19400</span>,</span><br><span class="line">              <span class="attr">&quot;category&quot;</span> : <span class="string">&quot;Men&#x27;s Clothing&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;sku&quot;</span> : <span class="string">&quot;ZO0299602996&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;taxless_price&quot;</span> : <span class="number">24.99</span>,</span><br><span class="line">              <span class="attr">&quot;unit_discount_amount&quot;</span> : <span class="number">0</span>,</span><br><span class="line">              <span class="attr">&quot;min_price&quot;</span> : <span class="number">11.75</span>,</span><br><span class="line">              <span class="attr">&quot;_id&quot;</span> : <span class="string">&quot;sold_product_584677_19400&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;discount_amount&quot;</span> : <span class="number">0</span>,</span><br><span class="line">              <span class="attr">&quot;created_on&quot;</span> : <span class="string">&quot;2016-12-26T09:28:48+00:00&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;product_name&quot;</span> : <span class="string">&quot;Sweatshirt - grey multicolor&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;price&quot;</span> : <span class="number">24.99</span>,</span><br><span class="line">              <span class="attr">&quot;taxful_price&quot;</span> : <span class="number">24.99</span>,</span><br><span class="line">              <span class="attr">&quot;base_unit_price&quot;</span> : <span class="number">24.99</span></span><br><span class="line">            &#125;</span><br><span class="line">          ],</span><br><span class="line">          <span class="attr">&quot;sku&quot;</span> : [</span><br><span class="line">            <span class="string">&quot;ZO0549605496&quot;</span>,</span><br><span class="line">            <span class="string">&quot;ZO0299602996&quot;</span></span><br><span class="line">          ],</span><br><span class="line">          <span class="attr">&quot;taxful_total_price&quot;</span> : <span class="number">36.98</span>,</span><br><span class="line">          <span class="attr">&quot;taxless_total_price&quot;</span> : <span class="number">36.98</span>,</span><br><span class="line">          <span class="attr">&quot;total_quantity&quot;</span> : <span class="number">2</span>,</span><br><span class="line">          <span class="attr">&quot;total_unique_products&quot;</span> : <span class="number">2</span>,</span><br><span class="line">          <span class="attr">&quot;type&quot;</span> : <span class="string">&quot;order&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;user&quot;</span> : <span class="string">&quot;eddie&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;geoip&quot;</span> : &#123;</span><br><span class="line">            <span class="attr">&quot;country_iso_code&quot;</span> : <span class="string">&quot;EG&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;location&quot;</span> : &#123;</span><br><span class="line">              <span class="attr">&quot;lon&quot;</span> : <span class="number">31.3</span>,</span><br><span class="line">              <span class="attr">&quot;lat&quot;</span> : <span class="number">30.1</span></span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="attr">&quot;region_name&quot;</span> : <span class="string">&quot;Cairo Governorate&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;continent_name&quot;</span> : <span class="string">&quot;Africa&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;city_name&quot;</span> : <span class="string">&quot;Cairo&quot;</span></span><br><span class="line">          &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">&quot;_explanation&quot;</span> : &#123;</span><br><span class="line">          <span class="attr">&quot;value&quot;</span> : <span class="number">8.399749</span>,</span><br><span class="line">          <span class="attr">&quot;description&quot;</span> : <span class="string">&quot;&quot;</span><span class="string">&quot;weight(customer_full_name:&quot;</span>eddie underwood<span class="string">&quot; in 0) [PerFieldSimilarity], result of:&quot;</span><span class="string">&quot;&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;details&quot;</span> : [</span><br><span class="line">            &#123;</span><br><span class="line">              <span class="attr">&quot;value&quot;</span> : <span class="number">8.399749</span>,</span><br><span class="line">              <span class="attr">&quot;description&quot;</span> : <span class="string">&quot;score(freq=1.0), computed as boost * idf * tf from:&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;details&quot;</span> : [</span><br><span class="line">                &#123;</span><br><span class="line">                  <span class="attr">&quot;value&quot;</span> : <span class="number">2.2</span>,</span><br><span class="line">                  <span class="attr">&quot;description&quot;</span> : <span class="string">&quot;boost&quot;</span>,</span><br><span class="line">                  <span class="attr">&quot;details&quot;</span> : [ ]</span><br><span class="line">                &#125;,</span><br><span class="line">                &#123;</span><br><span class="line">                  <span class="attr">&quot;value&quot;</span> : <span class="number">8.204263</span>,</span><br><span class="line">                  <span class="attr">&quot;description&quot;</span> : <span class="string">&quot;idf, sum of:&quot;</span>,</span><br><span class="line">                  <span class="attr">&quot;details&quot;</span> : [</span><br><span class="line">                    &#123;</span><br><span class="line">                      <span class="attr">&quot;value&quot;</span> : <span class="number">3.8400407</span>,</span><br><span class="line">                      <span class="attr">&quot;description&quot;</span> : <span class="string">&quot;idf, computed as log(1 + (N - n + 0.5) / (n + 0.5)) from:&quot;</span>,</span><br><span class="line">                      <span class="attr">&quot;details&quot;</span> : [</span><br><span class="line">                        &#123;</span><br><span class="line">                          <span class="attr">&quot;value&quot;</span> : <span class="number">100</span>,</span><br><span class="line">                          <span class="attr">&quot;description&quot;</span> : <span class="string">&quot;n, number of documents containing term&quot;</span>,</span><br><span class="line">                          <span class="attr">&quot;details&quot;</span> : [ ]</span><br><span class="line">                        &#125;,</span><br><span class="line">                        &#123;</span><br><span class="line">                          <span class="attr">&quot;value&quot;</span> : <span class="number">4675</span>,</span><br><span class="line">                          <span class="attr">&quot;description&quot;</span> : <span class="string">&quot;N, total number of documents with field&quot;</span>,</span><br><span class="line">                          <span class="attr">&quot;details&quot;</span> : [ ]</span><br><span class="line">                        &#125;</span><br><span class="line">                      ]</span><br><span class="line">                    &#125;,</span><br><span class="line">                    &#123;</span><br><span class="line">                      <span class="attr">&quot;value&quot;</span> : <span class="number">4.364222</span>,</span><br><span class="line">                      <span class="attr">&quot;description&quot;</span> : <span class="string">&quot;idf, computed as log(1 + (N - n + 0.5) / (n + 0.5)) from:&quot;</span>,</span><br><span class="line">                      <span class="attr">&quot;details&quot;</span> : [</span><br><span class="line">                        &#123;</span><br><span class="line">                          <span class="attr">&quot;value&quot;</span> : <span class="number">59</span>,</span><br><span class="line">                          <span class="attr">&quot;description&quot;</span> : <span class="string">&quot;n, number of documents containing term&quot;</span>,</span><br><span class="line">                          <span class="attr">&quot;details&quot;</span> : [ ]</span><br><span class="line">                        &#125;,</span><br><span class="line">                        &#123;</span><br><span class="line">                          <span class="attr">&quot;value&quot;</span> : <span class="number">4675</span>,</span><br><span class="line">                          <span class="attr">&quot;description&quot;</span> : <span class="string">&quot;N, total number of documents with field&quot;</span>,</span><br><span class="line">                          <span class="attr">&quot;details&quot;</span> : [ ]</span><br><span class="line">                        &#125;</span><br><span class="line">                      ]</span><br><span class="line">                    &#125;</span><br><span class="line">                  ]</span><br><span class="line">                &#125;,</span><br><span class="line">                &#123;</span><br><span class="line">                  <span class="attr">&quot;value&quot;</span> : <span class="number">0.46537602</span>,</span><br><span class="line">                  <span class="attr">&quot;description&quot;</span> : <span class="string">&quot;tf, computed as freq / (freq + k1 * (1 - b + b * dl / avgdl)) from:&quot;</span>,</span><br><span class="line">                  <span class="attr">&quot;details&quot;</span> : [</span><br><span class="line">                    &#123;</span><br><span class="line">                      <span class="attr">&quot;value&quot;</span> : <span class="number">1.0</span>,</span><br><span class="line">                      <span class="attr">&quot;description&quot;</span> : <span class="string">&quot;phraseFreq=1.0&quot;</span>,</span><br><span class="line">                      <span class="attr">&quot;details&quot;</span> : [ ]</span><br><span class="line">                    &#125;,</span><br><span class="line">                    &#123;</span><br><span class="line">                      <span class="attr">&quot;value&quot;</span> : <span class="number">1.2</span>,</span><br><span class="line">                      <span class="attr">&quot;description&quot;</span> : <span class="string">&quot;k1, term saturation parameter&quot;</span>,</span><br><span class="line">                      <span class="attr">&quot;details&quot;</span> : [ ]</span><br><span class="line">                    &#125;,</span><br><span class="line">                    &#123;</span><br><span class="line">                      <span class="attr">&quot;value&quot;</span> : <span class="number">0.75</span>,</span><br><span class="line">                      <span class="attr">&quot;description&quot;</span> : <span class="string">&quot;b, length normalization parameter&quot;</span>,</span><br><span class="line">                      <span class="attr">&quot;details&quot;</span> : [ ]</span><br><span class="line">                    &#125;,</span><br><span class="line">                    &#123;</span><br><span class="line">                      <span class="attr">&quot;value&quot;</span> : <span class="number">2.0</span>,</span><br><span class="line">                      <span class="attr">&quot;description&quot;</span> : <span class="string">&quot;dl, length of field&quot;</span>,</span><br><span class="line">                      <span class="attr">&quot;details&quot;</span> : [ ]</span><br><span class="line">                    &#125;,</span><br><span class="line">                    &#123;</span><br><span class="line">                      <span class="attr">&quot;value&quot;</span> : <span class="number">2.1206417</span>,</span><br><span class="line">                      <span class="attr">&quot;description&quot;</span> : <span class="string">&quot;avgdl, average length of field&quot;</span>,</span><br><span class="line">                      <span class="attr">&quot;details&quot;</span> : [ ]</span><br><span class="line">                    &#125;</span><br><span class="line">                  ]</span><br><span class="line">                &#125;</span><br><span class="line">              ]</span><br><span class="line">            &#125;</span><br><span class="line">          ]</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    ]</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><strong>Query Context</strong>（查询上下文）：Query Context主要包含的一些查询语句信息。他们主要反应文档匹配程度。除了内容匹配之外还有匹配文档相关性算分，返回结果会根据相关性算分排序</p>
<p><strong>Filter Context</strong>（过滤器上下文）：Filter Context也是包含一些查询语句。他主要反应的是文档是否匹配，没有匹配程度的概念，即查询出文档不需要相关性算分。Filter 可以利用缓存获得更好的性能</p>
<p>简单总结一下就是query context 内的查询子语句都是需要算分的，而filter context 的查询子语句不需要算分。当多个查询子语句复合使用的收就可以通过那些设置成功query 那些设置成filter来提高查询性能，不是所有查询字段都需要相关性算分。</p>
<h5 id="bool查询"><a href="#bool查询" class="headerlink" title="bool查询"></a>bool查询</h5><p>bool查询：默认的复合查询，包含一个简单或者多个简单查询。可以使用<code>must</code>、<code>must_not</code>、<code>should</code>、<code>filter</code>表示简单查询之间的逻辑。</p>
<ul>
<li><code>must</code>：文档必须要匹配<code>must</code>下的查询条件，参与算分。</li>
<li><code>should</code>：文档可以匹配也可以不匹配<code>should</code>下的查询条件，匹配的文档算分会更高</li>
<li><code>must_not</code>：匹配该选项下的查询条件的文档会被过滤，不会返回。</li>
<li><code>filter</code>：和<code>must</code>类似，不同的是<code>filter</code>中的条件不会参与算分。</li>
</ul>
<p>相关性算分不仅仅适用于全文本搜索。也适合返回yes|on的子语句的复合查询，匹配的子语句越多，相关性算分越高。<code>must</code>和<code>should</code>都会算分。</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//复合查询电子购物记录</span></span><br><span class="line">GET kibana_sample_data_ecommerce/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;query&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;bool&quot;</span>: &#123;</span><br><span class="line">      <span class="attr">&quot;must&quot;</span>: [</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="attr">&quot;term&quot;</span>: &#123;</span><br><span class="line">            <span class="attr">&quot;currency&quot;</span>: &#123; <span class="comment">//货币是欧元</span></span><br><span class="line">              <span class="attr">&quot;value&quot;</span>: <span class="string">&quot;EUR&quot;</span></span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="attr">&quot;match&quot;</span>: &#123;<span class="comment">//消费者的全名中存在Underwood</span></span><br><span class="line">            <span class="attr">&quot;customer_full_name&quot;</span>: <span class="string">&quot;Underwood&quot;</span></span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      ],</span><br><span class="line">      <span class="attr">&quot;must_not&quot;</span>: [</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="attr">&quot;term&quot;</span>: &#123;</span><br><span class="line">            <span class="attr">&quot;day_of_week&quot;</span>: &#123; <span class="comment">//不是在星期一购买的数据</span></span><br><span class="line">              <span class="attr">&quot;value&quot;</span>: <span class="string">&quot;Monday&quot;</span></span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="attr">&quot;match&quot;</span>: &#123; <span class="comment">//买的类目不是鞋子</span></span><br><span class="line">            <span class="attr">&quot;category&quot;</span>: <span class="string">&quot;shoes&quot;</span></span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      ],</span><br><span class="line">      <span class="attr">&quot;should&quot;</span>: [</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="attr">&quot;terms&quot;</span>: &#123; </span><br><span class="line">            <span class="attr">&quot;sku&quot;</span>: [ <span class="comment">//存在skuId 信息</span></span><br><span class="line">              <span class="string">&quot;ZO0299602996&quot;</span>,</span><br><span class="line">              <span class="string">&quot;ZO0549605496&quot;</span>,</span><br><span class="line">              <span class="string">&quot;ZO0489604896&quot;</span>,</span><br><span class="line">              <span class="string">&quot;ZO0185501855&quot;</span></span><br><span class="line">            ]</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="attr">&quot;range&quot;</span>: &#123; <span class="comment">//购买产品价格大于10元小于200元</span></span><br><span class="line">            <span class="attr">&quot;products.taxless_price&quot;</span>: &#123;</span><br><span class="line">              <span class="attr">&quot;gte&quot;</span>: <span class="number">10</span>,</span><br><span class="line">              <span class="attr">&quot;lte&quot;</span>: <span class="number">200</span></span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      ],</span><br><span class="line">      <span class="attr">&quot;filter&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">&quot;range&quot;</span>: &#123;</span><br><span class="line">          <span class="attr">&quot;order_date&quot;</span>: &#123; <span class="comment">//订单时间日期大于2010年1月1日，小于2022年10月10日</span></span><br><span class="line">            <span class="attr">&quot;gte&quot;</span>: <span class="string">&quot;2010-01-01&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;lte&quot;</span>: <span class="string">&quot;2022-10-10&quot;</span></span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h5 id="constant-score-查询"><a href="#constant-score-查询" class="headerlink" title="constant score 查询"></a>constant score 查询</h5><p>constant score 查询：检索可以包装一个其它类型的查询，并返回匹配过滤器中的查询条件且具备相同评分的文档。评分的数值默认是1.0，也可以使用<code>boost</code>参数。使用constant score 查询可以避免TF-IDF算分，部分提高效率</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//查询没有晚点的航班 指定相关性算分为1.5 返回结果_score字段得分都是1.5</span></span><br><span class="line">GET kibana_sample_data_flights/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;query&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;constant_score&quot;</span>: &#123;</span><br><span class="line">      <span class="attr">&quot;filter&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">&quot;term&quot;</span>: &#123;</span><br><span class="line">          <span class="attr">&quot;FlightDelay&quot;</span>: <span class="literal">false</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125; ,</span><br><span class="line">      <span class="attr">&quot;boost&quot;</span>: <span class="number">1.5</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="boosting-查询"><a href="#boosting-查询" class="headerlink" title="boosting 查询"></a>boosting 查询</h5><p>boosting查询：适用于需要对评分进行调整的场景，它会把多个查询封装在一起并调整其中一个查询条件的评分，但是不会把记录从返回结果中删除。positive用于提升相关性算分权重，negative用于降低相关性算分权重。negative_boost表示降低相关性权重的数值，一般在0到1之间。</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//查询航班信息落地国家信息，CH的权重提高，ES的权重降低。这样ES的就会排在后面</span></span><br><span class="line">GET kibana_sample_data_flights/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;query&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;boosting&quot;</span>: &#123;</span><br><span class="line">      <span class="attr">&quot;positive&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">&quot;match&quot;</span>: &#123;</span><br><span class="line">          <span class="attr">&quot;DestCountry&quot;</span>: <span class="string">&quot;CH&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="attr">&quot;negative&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">&quot;match&quot;</span>: &#123;</span><br><span class="line">          <span class="attr">&quot;DestCountry&quot;</span>: <span class="string">&quot;ES&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">        <span class="comment">//DestCountry等于ES的国家的评分会降低到原来的0.2倍,</span></span><br><span class="line">      <span class="attr">&quot;negative_boost&quot;</span>: <span class="number">0.2</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>也可以使用复合查询中的boost参数的值，调整相关性参数。boost&gt;1相关度算分权重提升，0&lt;boost&lt;1打分的相关度算分权重相对下降是原来的0到1倍之间，boost&lt;0表示相关度算分权重为负分。</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//在类目中提高男性衣服相关性算分权重为原来的1.5倍，降低女性衣服的相关性算分权重为原来的0.2倍</span></span><br><span class="line">GET kibana_sample_data_ecommerce/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;query&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;bool&quot;</span>: &#123;</span><br><span class="line">      <span class="attr">&quot;should&quot;</span>: [</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="attr">&quot;match&quot;</span>: &#123;</span><br><span class="line">          <span class="attr">&quot;category&quot;</span>: &#123;</span><br><span class="line">            <span class="attr">&quot;query&quot;</span>: <span class="string">&quot;Men&#x27;s Clothing&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;boost&quot;</span>:<span class="number">1.5</span></span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="attr">&quot;match&quot;</span>: &#123;</span><br><span class="line">            <span class="attr">&quot;category&quot;</span>: &#123;</span><br><span class="line">              <span class="attr">&quot;query&quot;</span>: <span class="string">&quot;Women&#x27;s Clothing&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;boost&quot;</span>: <span class="number">0.2</span></span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      ]</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="ES数据搜索的简单优化"><a href="#ES数据搜索的简单优化" class="headerlink" title="ES数据搜索的简单优化"></a>ES数据搜索的简单优化</h3><p><strong>相关性算分搜索的优化</strong></p>
<p>ES 使用term查询会有score 分数。一般会根据score分数来给出相关的查询关联度，关联度越高的，结果越靠前。将Query 转成filter，会忽略TF-IDF计算，避免相关性计算的开销（score 分数都是 0.0），filter 可以有效利用缓存。或者使用constant_score使所有等分都等1.0不进行计算。（使用constant_score和filter也算是复合搜索）</p>
<p>一般使用term查找的基本上都是等值查找和MySQL中的查找类似，把数据返回就可以了，然后可以通过排序字段进行手动排序，没有必要进行得分排序。不过如果你有需要可以使用score关联程度，那就把filter或者constant_score去掉就可以了。</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//查询没有晚点的航班 返回结果_score字段得分都是1.0</span></span><br><span class="line">GET kibana_sample_data_flights/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;query&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;constant_score&quot;</span>: &#123;</span><br><span class="line">      <span class="attr">&quot;filter&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">&quot;term&quot;</span>: &#123;</span><br><span class="line">          <span class="attr">&quot;FlightDelay&quot;</span>: <span class="literal">false</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125; </span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//查询没有晚点的飞机 返回的结果_score字段得分都是0.0</span></span><br><span class="line">GET /kibana_sample_data_flights/_search</span><br><span class="line">&#123;</span><br><span class="line">	<span class="attr">&quot;query&quot;</span>: &#123;</span><br><span class="line">		<span class="attr">&quot;bool&quot;</span>: &#123;</span><br><span class="line">			<span class="attr">&quot;filter&quot;</span>: &#123;</span><br><span class="line">				<span class="attr">&quot;term&quot;</span>: &#123;</span><br><span class="line">					 <span class="attr">&quot;FlightDelay&quot;</span>: <span class="literal">false</span></span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>优化查询中包含不是相等的问题</strong></p>
<p>ES在查询中一般都是包含，特别是在一个字段存储时是数组的数据类型，导致你只想查询其中的一个值，结果查询出来多个结果</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//查询manufacturer为 Oceanavigations的数据，但是由于manufacturer是数组存储，导致会返回所有包含Oceanavigations的数据</span></span><br><span class="line">GET kibana_sample_data_ecommerce/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;query&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;constant_score&quot;</span>: &#123;</span><br><span class="line">      <span class="attr">&quot;filter&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">&quot;term&quot;</span>: &#123;</span><br><span class="line">          <span class="attr">&quot;manufacturer.keyword&quot;</span>: <span class="string">&quot;Oceanavigations&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//结果中的一条</span></span><br><span class="line">&#123;</span><br><span class="line">        <span class="attr">&quot;_index&quot;</span> : <span class="string">&quot;kibana_sample_data_ecommerce&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;_type&quot;</span> : <span class="string">&quot;_doc&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;_id&quot;</span> : <span class="string">&quot;FHbQXoMB7xzzV5IgPJqV&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;_score&quot;</span> : <span class="number">1.0</span>,</span><br><span class="line">        <span class="attr">&quot;_source&quot;</span> : &#123;</span><br><span class="line">          <span class="attr">&quot;category&quot;</span> : [</span><br><span class="line">            <span class="string">&quot;Men&#x27;s Clothing&quot;</span></span><br><span class="line">          ],</span><br><span class="line">          <span class="attr">&quot;currency&quot;</span> : <span class="string">&quot;EUR&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;customer_first_name&quot;</span> : <span class="string">&quot;Eddie&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;customer_full_name&quot;</span> : <span class="string">&quot;Eddie Underwood&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;customer_gender&quot;</span> : <span class="string">&quot;MALE&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;customer_id&quot;</span> : <span class="number">38</span>,</span><br><span class="line">          <span class="attr">&quot;customer_last_name&quot;</span> : <span class="string">&quot;Underwood&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;customer_phone&quot;</span> : <span class="string">&quot;&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;day_of_week&quot;</span> : <span class="string">&quot;Monday&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;day_of_week_i&quot;</span> : <span class="number">0</span>,</span><br><span class="line">          <span class="attr">&quot;email&quot;</span> : <span class="string">&quot;eddie@underwood-family.zzz&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;manufacturer&quot;</span> : [ <span class="comment">//包含多条信息</span></span><br><span class="line">            <span class="string">&quot;Elitelligence&quot;</span>,</span><br><span class="line">            <span class="string">&quot;Oceanavigations&quot;</span></span><br><span class="line">          ],</span><br><span class="line">          <span class="attr">&quot;order_date&quot;</span> : <span class="string">&quot;2022-10-03T09:28:48+00:00&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;order_id&quot;</span> : <span class="number">584677</span>,</span><br><span class="line">        &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<p>解决这种问题，可以通过增加 manufacturer_count字段，增加 manufacturer_count在查询时候带上查询条件 manufacturer_count =1就可以解决。</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//增加manufacturer_count字段</span></span><br><span class="line">GET kibana_sample_data_ecommerce/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;query&quot;</span>: &#123;</span><br><span class="line">      <span class="attr">&quot;bool&quot;</span>: &#123;</span><br><span class="line">      <span class="attr">&quot;must&quot;</span>: [</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="attr">&quot;term&quot;</span>: &#123;</span><br><span class="line">          <span class="attr">&quot;manufacturer.keyword&quot;</span>: <span class="string">&quot;Oceanavigations&quot;</span></span><br><span class="line">          &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="attr">&quot;term&quot;</span>: &#123;</span><br><span class="line">          <span class="attr">&quot;manufacturer_count&quot;</span>: <span class="number">1</span></span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        ]</span><br><span class="line">        </span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>或者使用<code>must_not</code>去做排除，但是这种要把对应的枚举都做出来</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//通过must_not去排除对应字段的其他值，这种需要枚举其他数据</span></span><br><span class="line">GET kibana_sample_data_ecommerce/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;query&quot;</span>: &#123;</span><br><span class="line">      <span class="attr">&quot;bool&quot;</span>: &#123;</span><br><span class="line">      <span class="attr">&quot;must&quot;</span>: [</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="attr">&quot;term&quot;</span>: &#123;</span><br><span class="line">          <span class="attr">&quot;manufacturer.keyword&quot;</span>: <span class="string">&quot;Oceanavigations&quot;</span></span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        ],</span><br><span class="line">        <span class="attr">&quot;must_not&quot;</span>: [</span><br><span class="line">          &#123;</span><br><span class="line">            <span class="attr">&quot;terms&quot;</span>: &#123;</span><br><span class="line">              <span class="attr">&quot;manufacturer.keyword&quot;</span>: [</span><br><span class="line">                <span class="string">&quot;Low Tide Media&quot;</span>,</span><br><span class="line">                <span class="string">&quot;Elitelligence&quot;</span>,</span><br><span class="line">                <span class="string">&quot;Primemaster&quot;</span>,</span><br><span class="line">                <span class="string">&quot;Pyramidustries&quot;</span>,</span><br><span class="line">                <span class="string">&quot;Tigress Enterprises&quot;</span>,</span><br><span class="line">                <span class="string">&quot;Pyramidustries active&quot;</span>,</span><br><span class="line">                <span class="string">&quot;Angeldale&quot;</span>,</span><br><span class="line">                <span class="string">&quot;Microlutions&quot;</span></span><br><span class="line">              ]</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        ]</span><br><span class="line">      &#125;</span><br><span class="line">      </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这种优化一般根据业务去优化，如果你的数据是可以枚举的推荐使用<code>must_not</code>因为这种不用修改索引字段，但是如果数组中的数据不可以枚举，那就选择count也是一个不错的选择，不过这种要重建索引。</p>
<p><strong>ES搜索分页优化</strong></p>
<p>在ES查询中默认是可以使用分页的，就像MySQL中分页使用<code>offset</code> 和<code>limit</code>，在ES中使用<code>from</code>和<code>size</code>这两个参数。</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//查询落地为中国的航班 前5条数据</span></span><br><span class="line">GET kibana_sample_data_flights/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;query&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;match&quot;</span>: &#123;</span><br><span class="line">      <span class="attr">&quot;DestCountry&quot;</span>: <span class="string">&quot;CH&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">&quot;from&quot;</span>: <span class="number">0</span>,</span><br><span class="line">  <span class="attr">&quot;size&quot;</span>: <span class="number">5</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>不过这种使用方法，会有限制就是<code>from</code>+<code>size</code> 默认不能超过10000。可以通过修改索引参数index.max_result_window调整，但是这种方式在查询后会出现慢查询。</p>
<p>from + sizede 查询过程：协调节点将查询请求发送给所有分片，各分片收到请求后，查出 from + size 的数据，并返回给协调节点。例如：当前请求是查询第5~10笔数据，from + size = 10，因此每个分片都要返回排序后的前10笔数据，协调节点将收到的数据进行合并，重新排序，然后返回指定的size分页数据给客户端。</p>
<p>深分页的情况下，也就是from + size 值特别大，可能会造成慢查询。因为每个节点都需要返回 from + size 的排序数据，然后最终还需要合并以及排序，就算没有内存溢出，对CPU和IO也有巨大影响。</p>
<p>所以实现简单，适用于少量数据，数据量不超过10w，适合浅分页。当深度分页时性能较差</p>
<p>可以使用ES的<code>search_after</code>和去优化</p>
<p><code>search_after</code> 在排序的基础上，基于上一笔的sort值，查询排在它之后的数据，以此来实现分页。<code>search_after </code>是无状态的，它总是查询ES索引最新的数据，这一点跟 <code>scroll</code> 查询完全相反。（scroll 维护成本高，而且scroll_id 存在缓存时间，对于实时性也会有影响，所以后面不推荐使用）</p>
<p>不过使用时<code>search_after</code>一定要带排序参数，而且他的排序参数至少要两个，否则就会报错。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">GET kibana_sample_data_ecommerce&#x2F;_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;bool&quot;: &#123;</span><br><span class="line">      &quot;must&quot;: [</span><br><span class="line">        &#123;</span><br><span class="line">          &quot;match&quot;: &#123;</span><br><span class="line">          &quot;category&quot;: &#123;</span><br><span class="line">            &quot;query&quot;: &quot;Men&#39;s Clothing&quot;,</span><br><span class="line">            &quot;boost&quot;:1.5</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      ]</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;sort&quot;: [</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;order_id&quot;: &#123;</span><br><span class="line">        &quot;order&quot;: &quot;asc&quot;</span><br><span class="line">      &#125;,</span><br><span class="line">      &quot;order_date&quot;: &#123;</span><br><span class="line">        &quot;order&quot;: &quot;asc&quot;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">  ],</span><br><span class="line">  &#x2F;&#x2F;在排序order_id字段584677后分页2000000</span><br><span class="line">  &quot;search_after&quot;:[&quot;584677&quot;,2000000]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>排序字段大于两个报错信息</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;error&quot;</span> : &#123;</span><br><span class="line">    <span class="attr">&quot;root_cause&quot;</span> : [</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">&quot;type&quot;</span> : <span class="string">&quot;illegal_argument_exception&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;reason&quot;</span> : <span class="string">&quot;search_after has 2 value(s) but sort has 3.&quot;</span></span><br><span class="line">      &#125;</span><br><span class="line">    ],</span><br><span class="line">    <span class="attr">&quot;type&quot;</span> : <span class="string">&quot;search_phase_execution_exception&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;reason&quot;</span> : <span class="string">&quot;all shards failed&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;phase&quot;</span> : <span class="string">&quot;query&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;grouped&quot;</span> : <span class="literal">true</span>,</span><br><span class="line">    <span class="attr">&quot;failed_shards&quot;</span> : [</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">&quot;shard&quot;</span> : <span class="number">0</span>,</span><br><span class="line">        <span class="attr">&quot;index&quot;</span> : <span class="string">&quot;kibana_sample_data_ecommerce&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;node&quot;</span> : <span class="string">&quot;vj8gacmkRCS9gh9d9tassw&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;reason&quot;</span> : &#123;</span><br><span class="line">          <span class="attr">&quot;type&quot;</span> : <span class="string">&quot;illegal_argument_exception&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;reason&quot;</span> : <span class="string">&quot;search_after has 2 value(s) but sort has 3.&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    ],</span><br><span class="line">    <span class="attr">&quot;caused_by&quot;</span> : &#123;</span><br><span class="line">      <span class="attr">&quot;type&quot;</span> : <span class="string">&quot;illegal_argument_exception&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;reason&quot;</span> : <span class="string">&quot;search_after has 2 value(s) but sort has 3.&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;caused_by&quot;</span> : &#123;</span><br><span class="line">        <span class="attr">&quot;type&quot;</span> : <span class="string">&quot;illegal_argument_exception&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;reason&quot;</span> : <span class="string">&quot;search_after has 2 value(s) but sort has 3.&quot;</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">&quot;status&quot;</span> : <span class="number">400</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>这种分页做法时可以，但是不支持随便跳转页面，就像微博或者淘宝一直往下下拉分页，这种就可以避免随便跳页。</p>
<h3 id="总结-1"><a href="#总结-1" class="headerlink" title="总结"></a>总结</h3><p>写了关于这么多关于ES的内容，其实本质还是想把自己使用ES的过程记录下来，在接触ES这段时间发现，通过ES的使用可以提高查询效率，而且在做一下数据库上的统计信息计算，也可以通过ES的聚合实现。不用每次都写SQL计算，当数量大的时候，统计也是很耗时的。</p>
<p>还有就是通过ES可以做数据的聚合，即把原来几张表的数据，通过ES做成一个宽表这样在一些数据搜索时候额外的方便，不需要做跨表甚至跨库的查询。</p>
<p>在一个就是使用中ES的实时性的问题，这种可以通过canal去做binlog实时监听，将binlog信息转化成MQ消息同步给ES，可以做到秒级的实时笑果。这个地方肯定有人会问，为啥不canal直接同步ES数据，因为binlog本身有很多数据不一定需要处理（特别是在修改表结构产生大量不需要的同步数据），在同步过程中可能出现数据的聚合和调整，所以增加kafka消费时的在处理数据的时候增加中间层，可以做业务上的处理。</p>
<p>最后上面讲的也都是关于ES一些查询上的简单技巧，后续包括ES操作推荐使用<code>elasticsearch-rest-high-level-client</code>，这个就是一些API上的使用，可以简化我们代码上的处理。本文涉及到的所有的ES执行的DSL语句都是通过kibana执行的。</p>
<h3 id="杂记"><a href="#杂记" class="headerlink" title="杂记"></a>杂记</h3><p>TF-IDF算法：term frequency–inverse document frequency 是一种用于信息检索与数据挖掘的常用加权技术，常用于挖掘文章中的关键词，而且算法简单高效，常被工业用于最开始的文本数据清洗。</p>
<p>词频（Term Frequency）：某个词在文章中出现的频率。公式  词频 = 某个词出现的次数/整篇文章的总的词数</p>
<p>逆文档频率（inverse document frequency）：log（总文档数/存在该词的文档数+1）</p>
<p>TF-IDF = TF*IDF</p>
<p>例如小米手机就会被分词 小米 + 手机 小米手机的TF-IDF = 小米TF * 小米IDF + 手机TF * 手机 IDF。</p>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">Author: </span><span class="post-copyright-info"><a href="mailto:undefined">Hill</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">Link: </span><span class="post-copyright-info"><a href="https://blog.51cloud.win/2023/01/20/ElasticSearch%E6%9F%A5%E8%AF%A2%E6%B5%85%E8%B0%88/">https://blog.51cloud.win/2023/01/20/ElasticSearch%E6%9F%A5%E8%AF%A2%E6%B5%85%E8%B0%88/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">Copyright Notice: </span><span class="post-copyright-info">All articles in this blog are licensed under <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> unless stating additionally.</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/ElasticSearch/">ElasticSearch</a></div><div class="post_share"><div class="social-share" data-image="/img/00037.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="next-post pull-full"><a href="/2022/11/20/Java%E7%9A%84%E6%80%A7%E8%83%BD%E6%B5%8B%E8%AF%95%E5%B7%A5%E5%85%B7JMH/"><img class="next-cover" src="/img/00036.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">Next Post</div><div class="next_info">Java热点代码的性能测试工具JMH</div></div></a></div></nav></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="card-info-avatar is-center"><img class="avatar-img" src="/img/dog.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/><div class="author-info__name">Hill</div><div class="author-info__description">Stay Hungry Stay Foolish</div></div><div class="card-info-data"><div class="card-info-data-item is-center"><a href="/archives/"><div class="headline">Articles</div><div class="length-num">46</div></a></div><div class="card-info-data-item is-center"><a href="/tags/"><div class="headline">Tags</div><div class="length-num">26</div></a></div><div class="card-info-data-item is-center"><a href="/categories/"><div class="headline">Categories</div><div class="length-num">15</div></a></div></div><a class="button--animated" id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/ClaudeWilliam"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons is-center"><a class="social-icon" href="https://github.com/ClaudeWilliam" target="_blank" title="github"><i class="GitHub"></i></a><a class="social-icon" href="https://twitter.com/qjqandjack" target="_blank" title="twitter"><i class="Twitter"></i></a></div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>Catalog</span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BB%80%E4%B9%88%E6%98%AFElasticSearch"><span class="toc-number">1.</span> <span class="toc-text">什么是ElasticSearch</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#ES%E4%B8%AD%E7%9A%84%E4%B8%80%E4%BA%9B%E5%90%8D%E8%AF%8D%E8%A7%A3%E9%87%8A"><span class="toc-number">1.1.</span> <span class="toc-text">ES中的一些名词解释</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%B8%B8%E7%94%A8%E7%9A%84filed-datatype"><span class="toc-number">1.2.</span> <span class="toc-text">常用的filed-datatype</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%9F%A5%E7%9C%8B%E7%B4%A2%E5%BC%95%E8%AF%A6%E7%BB%86%E4%BF%A1%E6%81%AF"><span class="toc-number">1.3.</span> <span class="toc-text">查看索引详细信息</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%80%92%E6%8E%92%E7%B4%A2%E5%BC%95"><span class="toc-number">2.</span> <span class="toc-text">倒排索引</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ElasticSearch%E7%9A%84%E9%AB%98%E5%8F%AF%E7%94%A8%E4%B8%8E%E6%89%A9%E5%B1%95"><span class="toc-number">3.</span> <span class="toc-text">ElasticSearch的高可用与扩展</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%9B%86%E7%BE%A4%EF%BC%88cluster%EF%BC%89"><span class="toc-number">3.1.</span> <span class="toc-text">集群（cluster）</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%86%E7%89%87%EF%BC%88shards%EF%BC%89"><span class="toc-number">3.2.</span> <span class="toc-text">分片（shards）</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%89%AF%E6%9C%AC%EF%BC%88replica%EF%BC%89"><span class="toc-number">3.3.</span> <span class="toc-text">副本（replica）</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%80%BB%E7%BB%93"><span class="toc-number">3.4.</span> <span class="toc-text">总结</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ElasticSearch%E7%9A%84%E6%90%9C%E7%B4%A2%E6%96%B9%E5%BC%8F"><span class="toc-number">4.</span> <span class="toc-text">ElasticSearch的搜索方式</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#URI-API-Search"><span class="toc-number">4.1.</span> <span class="toc-text">URI API Search</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#DSL-Search-API"><span class="toc-number">4.2.</span> <span class="toc-text">DSL Search API</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ES%E7%9A%84%E6%90%9C%E7%B4%A2%E6%9F%A5%E8%AF%A2%E7%B1%BB%E5%9E%8B"><span class="toc-number">5.</span> <span class="toc-text">ES的搜索查询类型</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%AF%8D%E9%A1%B9%E6%9F%A5%E8%AF%A2%EF%BC%88Term-queries%EF%BC%89"><span class="toc-number">5.1.</span> <span class="toc-text">词项查询（Term queries）</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%85%A8%E6%96%87%E6%9C%AC%E6%9F%A5%E8%AF%A2%EF%BC%88Full-text-queries%EF%BC%89"><span class="toc-number">5.2.</span> <span class="toc-text">全文本查询（Full text queries）</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%A4%8D%E5%90%88%E6%9F%A5%E8%AF%A2%EF%BC%88Compound-queries-%EF%BC%89"><span class="toc-number">5.3.</span> <span class="toc-text">复合查询（Compound queries ）</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#bool%E6%9F%A5%E8%AF%A2"><span class="toc-number">5.3.1.</span> <span class="toc-text">bool查询</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#constant-score-%E6%9F%A5%E8%AF%A2"><span class="toc-number">5.3.2.</span> <span class="toc-text">constant score 查询</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#boosting-%E6%9F%A5%E8%AF%A2"><span class="toc-number">5.3.3.</span> <span class="toc-text">boosting 查询</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ES%E6%95%B0%E6%8D%AE%E6%90%9C%E7%B4%A2%E7%9A%84%E7%AE%80%E5%8D%95%E4%BC%98%E5%8C%96"><span class="toc-number">6.</span> <span class="toc-text">ES数据搜索的简单优化</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%80%BB%E7%BB%93-1"><span class="toc-number">7.</span> <span class="toc-text">总结</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9D%82%E8%AE%B0"><span class="toc-number">8.</span> <span class="toc-text">杂记</span></a></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>Recent Post</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/2023/01/20/ElasticSearch%E6%9F%A5%E8%AF%A2%E6%B5%85%E8%B0%88/" title="ElasticSearch查询浅谈"><img src="/img/00037.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="ElasticSearch查询浅谈"/></a><div class="content"><a class="title" href="/2023/01/20/ElasticSearch%E6%9F%A5%E8%AF%A2%E6%B5%85%E8%B0%88/" title="ElasticSearch查询浅谈">ElasticSearch查询浅谈</a><time datetime="2023-01-20T12:03:14.000Z" title="Created 2023-01-20 20:03:14">2023-01-20</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2022/11/20/Java%E7%9A%84%E6%80%A7%E8%83%BD%E6%B5%8B%E8%AF%95%E5%B7%A5%E5%85%B7JMH/" title="Java热点代码的性能测试工具JMH"><img src="/img/00036.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Java热点代码的性能测试工具JMH"/></a><div class="content"><a class="title" href="/2022/11/20/Java%E7%9A%84%E6%80%A7%E8%83%BD%E6%B5%8B%E8%AF%95%E5%B7%A5%E5%85%B7JMH/" title="Java热点代码的性能测试工具JMH">Java热点代码的性能测试工具JMH</a><time datetime="2022-11-20T12:03:14.000Z" title="Created 2022-11-20 20:03:14">2022-11-20</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2022/10/10/MySQL%E4%B8%AD%E7%9A%84%E6%AD%BB%E9%94%81/" title="MySQL的死锁"><img src="/img/00035.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="MySQL的死锁"/></a><div class="content"><a class="title" href="/2022/10/10/MySQL%E4%B8%AD%E7%9A%84%E6%AD%BB%E9%94%81/" title="MySQL的死锁">MySQL的死锁</a><time datetime="2022-10-10T12:03:14.000Z" title="Created 2022-10-10 20:03:14">2022-10-10</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2022/06/20/Reactor%E6%A8%A1%E5%BC%8F%E4%B8%8EEventLoop/" title="Reactor模式与EventLoop"><img src="/img/00034.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Reactor模式与EventLoop"/></a><div class="content"><a class="title" href="/2022/06/20/Reactor%E6%A8%A1%E5%BC%8F%E4%B8%8EEventLoop/" title="Reactor模式与EventLoop">Reactor模式与EventLoop</a><time datetime="2022-06-20T12:03:14.000Z" title="Created 2022-06-20 20:03:14">2022-06-20</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2022/02/10/MySQL%E4%B8%AD%E7%9A%84%E9%94%81%E5%92%8CMVCC/" title="MySQL中的锁与MVCC"><img src="/img/00033.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="MySQL中的锁与MVCC"/></a><div class="content"><a class="title" href="/2022/02/10/MySQL%E4%B8%AD%E7%9A%84%E9%94%81%E5%92%8CMVCC/" title="MySQL中的锁与MVCC">MySQL中的锁与MVCC</a><time datetime="2022-02-10T12:03:14.000Z" title="Created 2022-02-10 20:03:14">2022-02-10</time></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2017 - 2023 By Hill</div><div class="framework-info"><span>Framework </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>Theme </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="Read Mode"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="Toggle Between Light And Dark Mode"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="Toggle between single-column and double-column"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="Setting"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="Table Of Contents"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="Back To Top"><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><div class="js-pjax"><script>if (!window.MathJax) {
  window.MathJax = {
    loader: {
      source: {
        '[tex]/amsCd': '[tex]/amscd'
      }
    },
    tex: {
      inlineMath: [ ['$','$'], ["\\(","\\)"]],
      tags: 'ams'
    },
    options: {
      renderActions: {
        findScript: [10, doc => {
          for (const node of document.querySelectorAll('script[type^="math/tex"]')) {
            const display = !!node.type.match(/; *mode=display/)
            const math = new doc.options.MathItem(node.textContent, doc.inputJax[0], display)
            const text = document.createTextNode('')
            node.parentNode.replaceChild(text, node)
            math.start = {node: text, delim: '', n: 0}
            math.end = {node: text, delim: '', n: 0}
            doc.math.push(math)
          }
        }, ''],
        addClass: [200,() => {
          document.querySelectorAll('mjx-container:not([display=\'true\']').forEach( node => {
            const target = node.parentNode
            if (!target.classList.contains('has-jax')) {
              target.classList.add('mathjax-overflow')
            }
          })
        }, '', false]
      }
    }
  }
  
  const script = document.createElement('script')
  script.src = 'https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js'
  script.id = 'MathJax-script'
  script.async = true
  document.head.appendChild(script)
} else {
  MathJax.startup.document.state(0)
  MathJax.texReset()
  MathJax.typeset()
}</script></div><canvas class="fireworks" mobile="false"></canvas><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/dist/fireworks.min.js"></script><script defer="defer" id="ribbon" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/dist/canvas-ribbon.min.js" size="150" alpha="0.6" zIndex="-1" mobile="false" data-click="false"></script><script defer="defer" id="fluttering_ribbon" mobile="true" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/dist/canvas-fluttering-ribbon.min.js"></script><script id="canvas_nest" defer="defer" color="0,0,255" opacity="0.7" zIndex="-1" count="99" mobile="false" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/dist/canvas-nest.min.js"></script><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/dist/activate-power-mode.min.js"></script><script>POWERMODE.colorful = true;
POWERMODE.shake = true;
POWERMODE.mobile = false;
document.body.addEventListener('input', POWERMODE);
</script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>